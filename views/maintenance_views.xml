<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="maintenance_request_view_form_inherit_horometer" model="ir.ui.view">
        <field name="name">maintenance.request.form.inherit.horometer</field>
        <field name="model">maintenance.request</field>
        <field name="inherit_id" ref="maintenance.hr_equipment_request_view_form"/>
        <field name="arch" type="xml">
            
            <xpath expr="//field[@name='schedule_date']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='duration']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='priority']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='email_cc']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='name']" position="after">
                <label for="request_title" class="oe_edit_only"/>
                <h1>
                    <field name="request_title" placeholder="Ej. Falla en motor principal..."/>                
                </h1>
            </xpath>

            <xpath expr="//field[@name='equipment_id']" position="replace">
                <field name="partner_id" widget="res_partner_many2one" context="{'res_partner_search_mode': 'customer'}"/>
                <field  name="equipment_id"
                        domain="[('partner_id', '=', partner_id)]"
                        context="{'default_partner_id': partner_id}"/>
            </xpath>

            <xpath expr="//field[@name='user_id']" position="replace">
                <field name="technician_id" widget="many2many_tags" placeholder="Seleccionar técnicos..."/>
                <field name="hour_type" widget="radio" options="{'horizontal': true}"/>

                <separator string="Checklist de Servicio"/>
                <field name="checklist_ids">
                    <list editable="bottom">
                        <field name="is_done" widget="boolean_toggle" width="30px"/> 
                        <field name="name" string="Tarea a realizar"/>
                    </list>
                </field>

                <separator string="Pendientes"/>
                <field name="has_pending" widget="radio" options="{'horizontal': true}"/>

                <field  name="pending_comments" 
                        placeholder="Detalla aquí los repuestos faltantes o tareas pendientes... "
                        invisible="has_pending != 'yes' "/>
                
            </xpath>

            <xpath expr="//field[@name='maintenance_type']" position="after">
                <separator string="Estado Inicial del Equipo"/>
                <field name="equipment_found_status" widget="radio" options="{'horizontal': true}"/>
                
                <separator string="Estado Final del Equipo"/>
                <field name="equipment_final_status" widget="radio" options="{'horizontal': true}"/>   

                <separator string="Califiación de Servicio"/>
                <field name="service_rating" widget="radio" options="{'horizontal': true}"/>
            </xpath>

            <xpath expr="//sheet/group" position="after">
                <group string="Control de Horómetro y Tiempos">
                    <group>
                        <field name="execution_start_date"/>
                        <field name="execution_end_date"/>
                    </group>
                </group>
            </xpath>

            <xpath expr="//sheet/notebook" position="inside">
                <page string="Evidencias y Firma">
                    <group>
                        <group>
                            <field name="signed_by_customer" placeholder="Nombre de quien recibe..."/>
                        </group>
                        <group>
                            <field name="signed_by_technician" placeholder="Nombre del técnico responsable..."/>
                        </group>
                        <group string="Conformidad">
                            <div colspan="2" class="d-flex justify-content-between align-items-center">
                                <h3 class="mb0">Firma del Cliente</h3>
                                <button name="action_clean_signature" 
                                        type="object" 
                                        string="Limpiar" 
                                        icon="fa-trash" 
                                        class="btn btn-link text-danger btn-sm" 
                                        confirm="¿Borrar firma?"/>
                            </div>
                            <separator colspan="2"/>
                            <field name="customer_signature" 
                                widget="signature" 
                                nolabel="1" 
                                colspan="2" 
                                style="width: 400px; height: 120px; border: 1px solid #ccc;"/>
                        </group>
                        
                        <group string="Gestión de Evidencias">
                            <field name="evidence_ids" widget="many2many_binary" string="Subir Fotos Aquí"/>
                            
                            <div class="text-muted">
                                <small><i>Usa el botón de arriba para cargar o eliminar imágenes. Las previsualizaciones aparecerán abajo.</i></small>
                            </div>
                        </group>
                    </group>

                    <separator string="Galería de Fotos"/>
                    <field name="evidence_ids" mode="kanban" readonly="1">
                        <kanban string="Evidencias Fotográficas">
                            <field name="id"/>
                            <field name="mimetype"/>
                            <field name="name"/>
                            <templates>
                                <t t-name="kanban-box">
                                    <div class="oe_kanban_card">
                                        <div class="o_kanban_image" style="position: relative;">
                                            <img t-att-src="kanban_image('ir.attachment', 'datas', record.id.raw_value)" 
                                                t-if="record.mimetype.value.indexOf('image') !== -1"
                                                style="width: 100%; height: auto; object-fit: cover;"/>
                                            <img src="/web/static/img/mimetypes/unknown.svg" 
                                                t-if="record.mimetype.value.indexOf('image') === -1" 
                                                class="o_image_64_max"/>
                                        </div>
                                        <div class="o_kanban_details" style="text-align: center; padding-top: 5px;">
                                            <span style="font-size: 11px;"><field name="name"/></span>
                                        </div>
                                    </div>
                                </t>
                            </templates>
                        </kanban>
                    </field>
                </page>
            </xpath>

        </field>
    </record>
</odoo>